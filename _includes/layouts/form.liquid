{% include 'parts/head.liquid' %}
{% include 'parts/header.liquid' %}

<div class="columns small-12 large-5 large-offset-1">
    <div class="form-box fill-blue-dark-dark light-blue-light-light radius-25 space-50"
        style="box-shadow: 0 0 1px 1px rgba(0, 102, 255, 0.2), 0 0 var(--space-200) 0px rgba(0, 102, 255, 0.3);">
        <form id="addCustomerForm" method="POST" enctype="multipart/form-data">
            <div class="row">
                <div class="columns small-12 space-25">
                    <div class="h4">Add Customer:</div>
                </div>

                <!-- Customer Basic Information -->
                <div class="columns small-12 large-6 space-25">
                    <label class="block">
                        <span
                            class="label form-label text-uppercase inline cursor-pointer space-min fill-blue-dark-dark">First
                            Name <span class="text-orange">*</span></span>
                        <input type="text" name="fname" required class="input-field block">
                    </label>
                </div>
                <div class="columns small-12 large-6 space-25">
                    <label class="block">
                        <span
                            class="label form-label text-uppercase inline cursor-pointer space-min fill-blue-dark-dark">Last
                            Name <span class="text-orange">*</span></span>
                        <input type="text" name="lname" required class="input-field block">
                    </label>
                </div>
                <div class="columns small-12 large-6 space-25">
                    <label class="block">
                        <span
                            class="label form-label text-uppercase inline cursor-pointer space-min fill-blue-dark-dark">Company
                            Name</span>
                        <input type="text" name="company-name" class="input-field block">
                    </label>
                </div>
                <div class="columns small-12 large-6 space-25">
                    <label class="block">
                        <span
                            class="label form-label text-uppercase inline cursor-pointer space-min fill-blue-dark-dark">Mobile
                            <span class="text-orange">*</span></span>
                        <input type="text" name="mobile" required class="input-field block">
                    </label>
                </div>
                <div class="columns small-12 large-6 space-25">
                    <label class="block">
                        <span
                            class="label form-label text-uppercase inline cursor-pointer space-min fill-blue-dark-dark">Telephone</span>
                        <input type="text" name="telephone" class="input-field block">
                    </label>
                </div>
                <div class="columns small-12 large-6 space-25">
                    <label class="block">
                        <span
                            class="label form-label text-uppercase inline cursor-pointer space-min fill-blue-dark-dark">Email</span>
                        <input type="email" name="email" class="input-field block">
                    </label>
                </div>

                <!-- Address Information -->
                <div class="columns small-12 large-6 space-25">
                    <label class="block">
                        <span
                            class="label form-label text-uppercase inline cursor-pointer space-min fill-blue-dark-dark">Current
                            Address Line 1 <span class="text-orange">*</span></span>
                        <input type="text" name="current-line1" required class="input-field block">
                    </label>
                </div>
                <div class="columns small-12 large-6 space-25">
                    <label class="block">
                        <span class="label form-label text-uppercase inline cursor-pointer space-min fill-blue-dark-dark">Current
                            Address Line 2 <span class="text-orange">*</span></span>
                        <input type="text" name="current-line2" required class="input-field block">
                    </label>
                </div>
                <div class="columns small-12 large-6 space-25">
                    <label class="block">
                        <span
                            class="label form-label text-uppercase inline cursor-pointer space-min fill-blue-dark-dark">Current
                            Area</span>
                        <input type="text" name="current-area" class="input-field block">
                    </label>
                </div>
                <div class="columns small-12 large-6 space-25">
                    <label class="block">
                        <span
                            class="label form-label text-uppercase inline cursor-pointer space-min fill-blue-dark-dark">Current
                            City ID</span>
                        <input type="text" name="current-ctid" class="input-field block">
                    </label>
                </div>
                <div class="columns small-12 large-6 space-25">
                    <label class="block">
                        <span
                            class="label form-label text-uppercase inline cursor-pointer space-min fill-blue-dark-dark">Current
                            Pincode <span class="text-orange">*</span></span>
                        <input type="text" name="current-pincode" required class="input-field block">
                    </label>
                </div>
                <div class="columns small-12 large-6 space-25">
                    <label class="block">
                        <span
                            class="label form-label text-uppercase inline cursor-pointer space-min fill-blue-dark-dark">Website</span>
                        <input type="url" name="website" class="input-field block">
                    </label>
                </div>

                <!-- Customer Type Information -->
                <div class="columns small-12 large-6 space-25">
                    <label class="block">
                        <span class="label form-label text-uppercase inline cursor-pointer space-min fill-blue-dark-dark">Customer Type <span class="text-orange">*</span></span>
                        <select name="customer-type" required class="input-field block">
                            <option value="blank" disabled="disabled" selected="selected">Select</option>
                            <option value="individual">Individual</option>
                            <option value="business">Business</option>
                        </select>
                    </label>
                </div>
                <div class="columns small-12 large-6 space-25">
                    <label class="block">
                        <span
                            class="label form-label text-uppercase inline cursor-pointer space-min fill-blue-dark-dark">Soft
                            Credit Days</span>
                        <input type="number" name="soft_credit_days" class="input-field block">
                    </label>
                </div>

                <!-- Referral and Collection -->
                <div class="columns small-12 space-25">
                    <label class="block">
                        <span
                            class="label form-label text-uppercase inline cursor-pointer space-min fill-blue-dark-dark">Referral
                            Type</span>
                        <input type="text" name="referral_type" class="input-field block">
                    </label>
                </div>
                <div class="columns small-12 space-25">
                    <label class="block">
                        <span
                            class="label form-label text-uppercase inline cursor-pointer space-min fill-blue-dark-dark">Collection
                            Date</span>
                        <input type="date" name="collection_date" class="input-field block">
                    </label>
                </div>
                <div class="columns small-12 space-25">
                    <label class="block">
                        <span
                            class="label form-label text-uppercase inline cursor-pointer space-min fill-blue-dark-dark">Ledger
                            Group Name <span class="text-orange">*</span></span>
                        <select name="ledger_group_name" id="ledgerGroupName" class="input-field block" required>
                            <option value="" disabled selected>Select Ledger Group</option>
                            <!-- Options will be populated here -->
                        </select>
                    </label>
                </div>

                <div class="columns small-12 space-25">
                    <label class="block">
                        <span
                            class="label form-label text-uppercase inline cursor-pointer space-min invisible">Submit</span>
                        <button class="button fill-blue block" type="submit">Add Customer</button>
                    </label>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    // Populate ledger group dropdown
    document.addEventListener("DOMContentLoaded", async function () {
        const ledgerGroupSelect = document.getElementById("ledgerGroupName");

        try {
            const response = await fetch("http://bgc.sixorbit.com/?urlq=service&version=4.0&key=123&task=customer%2Ffetch_addCustomer_form_data&user_id=410002480&access_token=6821080770312111620");
            const data = await response.json();

            // Verify the structure of account_groups data in console
            if (data.data && data.data.account_groups && Array.isArray(data.data.account_groups)) {
                data.data.account_groups.forEach(group => {
                    const option = document.createElement("option");
                    option.value = group.ledger_group_id;

                    // Display both name and ID in the dropdown text
                    option.textContent = `${group.ledger_group_name} (${group.ledger_group_id})`;

                    ledgerGroupSelect.appendChild(option);
                });
            } else {
                console.error("Account groups not found or not in the expected format:", data);
            }
        } catch (error) {
            console.error("Error fetching account groups:", error);
            alert("Failed to load ledger groups. Please try again later.");
        }
    });

    // Send form data
    document.getElementById("addCustomerForm").addEventListener("submit", async function (event) {
        event.preventDefault();

        // Set up form data
        const form = document.getElementById("addCustomerForm");
        const formData = new FormData(form);

        const payload = {
            "pan": "",
            "site-add-lname": "",
            "vendor_alid": "",
            "customer-type": "1",
            "fname": formData.get("fname"),
            "legal_name": "",
            "soft_credit_days": formData.get("soft_credit_days"),
            "primary_Ao_no": "",
            "salutation": "",
            "auth_token": "",
            "dateOfAnniwersary": "",
            "outletid": ["410000357"],
            "site-line2": "",
            "secondary_Ao_no": "",
            "dateOfBirth": "",
            "trasaction_type": 1,
            "current-add-lname": formData.get("current-line2"),
            "customer-sales-type": "1",
            "site-add-sitename": "",
            "applicant_place": "",
            "ao_code_under_whom_assessed": "",
            "cuterid": "63",
            "site-satid": "",
            "present_ward": "",
            "gender": "1",
            "site-area": "",
            "secondary_area_code": "",
            "applicant_name": "",
            "refer-cuid": "",
            "dnd_checked": "0",
            "site-add-fname": "",
            "current-ctid": "1",
            "assessed_in_which_ward": "",
            "primary_area_code": "",
            "refer-codeid": "",
            "assigned_user": "410002480",
            "applicant_status": "",
            "current-area": formData.get("current-area"),
            "form27C_checkBox": 0,
            "telephone": formData.get("telephone"),
            "current-add-fname": "test",
            "tax_payer_type": "",
            "space": "",
            "customer-type-radio": 2,
            "site-pincode": "",
            "site_addr": "",
            "collection_date": formData.get("collection_date"),
            "current-add-sitename": formData.get("current-add-sitename"),
            "current-pincode": formData.get("current-pincode"),
            "current-stid": formData.get("current-stid"),
            "gstin": "",
            "registration_date": "",
            "email": formData.get("email"),
            "area": "",
            "aadhar": "",
            "primary_AO_type": "",
            "budget": formData.get("budget"),
            "site-line1": "",
            "prproid": [],
            "site-stid": formData.get("site-stid"),
            "nature_of_bussiness": "",
            "referal-type": "",
            "ao_code": "",
            "secondary_AO_type": "",
            "registration_type": 4,
            "terms_conditions": [
                {
                    "values": [{ "tcsvid": "196" }],
                    "is_valid": true,
                    "tcsid": "65"
                }
            ],
            "current-line1": formData.get("current-line1"),
            "territory_name": "thalassery",
            "site-add-mobile": "",
            "soft_credit_limit": "",
            "venid": "",
            "site-coverid": formData.get("site-coverid"),
            "secondary_range_code": "",
            "current-add-mobile": formData.get("current-add-mobile"),
            "website": "",
            "site-ctid": formData.get("site-ctid"),
            "last_assessment_year": "",
            "mobile": formData.get("mobile"),
            "dontCall_checked": "0",
            "current-satid": "",
            "contact-person-combo": "[]",
            "lname": formData.get("lname"),
            "current-line2": formData.get("current-line2"),
            "primary_range_code": "",
            "hard_credit_days": "",
            "current-coverid": formData.get("current-coverid"),
            "trade_name": "",
            "day": "",
            "company_name": formData.get("company-name"),
            "salttid": "2",
            "calculated_from": 0,
            "nature_of_goods": "",
            "payment_terms": 3,
            "cdid": [],
            "display_name": "",
            "contact-detail-check": formData.get("contact-detail-check"),
            "hard_credit_limit": "",
            "ledger-group": formData.get("ledger_group_name"),
            "gstin_status": ""
        };

        const url = "http://bgc.sixorbit.com/?urlq=service&version=4.0&key=123&task=customer/add_customer&user_id=410002480&access_token=6626416481068592644";
        
        // Append data to formData
        formData.append("data", JSON.stringify(payload));

        axios.post(url, formData, {
            headers: {
                "Content-Type": "multipart/form-data"
            }
        })
        .then(response => {
            alert("Customer added successfully!");
            form.reset();
        })
        .catch(error => {
            console.error("Error:", error);
            alert(`Error: ${result.message}`);
        });
    });
</script>